<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="description" content="ROCCA UBALDINESCA">
  <meta name="author" content="ARCANGELO PRIORE">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Potree Viewer – ROCCA UBALDINESCA</title>

  <link rel="stylesheet" href="./build/potree/potree.css">
  <link rel="stylesheet" href="./libs/jquery-ui/jquery-ui.min.css">
  <link rel="stylesheet" href="./libs/openlayers3/ol.css">
  <link rel="stylesheet" href="./libs/spectrum/spectrum.css">
  <link rel="stylesheet" href="./libs/jstree/themes/mixed/style.css">
</head>

<body>

  <!-- LIBS -->
  <script src="./libs/jquery/jquery-3.1.1.min.js"></script>
  <script src="./libs/jquery-ui/jquery-ui.min.js"></script>
  <script src="./libs/spectrum/spectrum.js"></script>
  <script src="./libs/other/BinaryHeap.js"></script>
  <script src="./libs/tween/tween.min.js"></script>
  <script src="./libs/d3/d3.js"></script>
  <script src="./libs/proj4/proj4.js"></script>
  <script src="./libs/openlayers3/ol.js"></script>
  <script src="./libs/i18next/i18next.js"></script>
  <script src="./libs/jstree/jstree.js"></script>
  <script src="./build/potree/potree.js"></script>
  <script src="./libs/plasio/js/laslaz.js"></script>

  <!-- CONTAINER -->
  <div class="potree_container" style="position:absolute; width:100%; height:100%; left:0; top:0;">
    <div id="potree_render_area" style="background-image:url('');"></div>
    <div id="potree_sidebar_container"></div>
  </div>

  <!-- SCRIPT -->
  <script type="module">
    import * as THREE from "./libs/three.js/build/three.module.js";

    // =====================
    // LABELS (names shown in Scene / Objects)
    // =====================
    const SASSO_LABEL = "Rocca Ubaldinesca";
    const BUSTO_LABEL = "Busto di Francesco di Giorgio Martini";

    // =====================
    // VIEWER
    // =====================
    window.viewer = new Potree.Viewer(document.getElementById("potree_render_area"));

    // EDL: keep OFF by default (user can toggle via GUI checkbox)
    viewer.setEDLEnabled(false);

    viewer.setFOV(60);
    viewer.setPointBudget(10_000_000);
    viewer.loadSettingsFromURL();

    // loadSettingsFromURL may re-enable EDL via URL params -> force OFF again
    viewer.setEDLEnabled(false);

    viewer.setDescription("ROCCA UBALDINESCA");

    // Throttle streaming during navigation (if supported by this Potree build)
    if (typeof viewer.setMaxNodesLoading === "function") {
      viewer.setMaxNodesLoading(2);
    } else if (viewer.maxNodesLoading !== undefined) {
      viewer.maxNodesLoading = 2;
    } else if (Potree.maxNodesLoading !== undefined) {
      Potree.maxNodesLoading = 2;
    }

    // Min node size: set to 0
    if (typeof viewer.setMinNodeSize === "function") {
      viewer.setMinNodeSize(0);
    }

    // GUI
    viewer.loadGUI(() => {
      $("#menu_appearance").next().show();
      // GUI may restore settings -> keep EDL OFF by default
      viewer.setEDLEnabled(false);
    });

    // =====================
    // CONFIG DATASETS
    // =====================
    const SASSOCORVARO = {
      base: "./pointclouds/sassocorvaro",
      tiles: 20,
      pcs: [],
      materials: [],
      visible: true
    };

    const BUSTO = {
      path: "./pointclouds/busto/metadata.json",
      pc: null,
      materials: [],
      visible: true
    };

    // =====================
    // DEFAULT MATERIAL SETTINGS (used to restore)
    // =====================
    const DEFAULTS = {
      rocca: { size: 2.0, minSize: 2.0, type: Potree.PointSizeType.FIXED },
      busto: { size: 2.0, minSize: 2.0, type: Potree.PointSizeType.FIXED }
    };

    // =====================
    // MATERIAL DEFAULTS (keeps native Potree UI options)
    // =====================
    function applyMaterialDefaults(pc, materialsArr){
      const mat = pc.material;

      mat.activeAttributeName = "rgba";
      mat.size = DEFAULTS.rocca.size;
      mat.minSize = DEFAULTS.rocca.minSize;
      mat.pointSizeType = DEFAULTS.rocca.type;

      materialsArr.push(mat);
      return mat;
    }

    // =====================
    // TWO SEPARATE POINT-SIZE SLIDERS (one per cloud)
    // =====================
    function addPointSizeSliderForGroup(opts){
      const { id, title, materialsRef, initialMaterial } = opts;

      const $appearancePanel = $("#menu_appearance").next();
      if ($appearancePanel.length === 0) {
        setTimeout(() => addPointSizeSliderForGroup(opts), 200);
        return;
      }

      // remove only our custom block (do NOT touch native Potree controls)
      $(`#${id}`).remove();

      const typeToValue = t =>
        t === Potree.PointSizeType.ATTENUATED ? "ATTENUATED" :
        t === Potree.PointSizeType.ADAPTIVE   ? "ADAPTIVE"   : "FIXED";

      const valueToType = v =>
        v === "ATTENUATED" ? Potree.PointSizeType.ATTENUATED :
        v === "ADAPTIVE"   ? Potree.PointSizeType.ADAPTIVE   :
                             Potree.PointSizeType.FIXED;

      const block = $(`
        <div class="pv-menu-list" id="${id}">
          <div class="pv-menu-entry">

            <div style="font-weight:600; margin-bottom:8px;">${title}</div>

            <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
              <span>Point size</span>
              <span id="${id}_val">${initialMaterial.size.toFixed(1)}</span>
            </div>

            <div id="${id}_slider" style="margin:0 4px;"></div>

            <div id="${id}_note"
                 style="margin-top:6px; font-size:11px; color:#999; display:none;">
              controlled by distance
            </div>

            <div style="display:flex; justify-content:space-between; margin-top:8px;">
              <span>Size mode</span>
              <select id="${id}_type" style="width:140px;">
                <option value="FIXED">Fixed</option>
                <option value="ATTENUATED">Attenuated</option>
                <option value="ADAPTIVE">Adaptive</option>
              </select>
            </div>

          </div>
        </div>
      `);

      const $firstBlock = $appearancePanel.find(".pv-menu-list").first();
      $firstBlock.after(block);

      $(`#${id}_type`).val(typeToValue(initialMaterial.pointSizeType));

      $(`#${id}_slider`).slider({
        min: 0.5,
        max: 10,
        step: 0.1,
        value: initialMaterial.size,
        slide: (e, ui) => {
          materialsRef.forEach(m => { m.size = ui.value; });
          $(`#${id}_val`).text(ui.value.toFixed(1));
        }
      });

      function applyMode(mode){
        const $slider = $(`#${id}_slider`);
        const $note = $(`#${id}_note`);

        const t = valueToType(mode);
        materialsRef.forEach(m => { m.pointSizeType = t; });

        if (mode === "ATTENUATED") {
          $slider.slider("disable");
          $note.show();
          return;
        }

        $slider.slider("enable");
        $note.hide();

        if (mode === "ADAPTIVE") {
          $slider.slider("option", "max", 3);
          if ($slider.slider("value") > 3) {
            $slider.slider("value", 3);
            materialsRef.forEach(m => { m.size = 3; });
            $(`#${id}_val`).text("3.0");
          }
        } else {
          $slider.slider("option", "max", 10);
        }
      }

      applyMode(typeToValue(initialMaterial.pointSizeType));

      $(`#${id}_type`).on("change", function(){
        applyMode($(this).val());
      });
    }

    // =====================
    // INITIAL FIT
    // =====================
    let bustoLoaded = false;
    let tilesLoaded = 0;

    let fitQuickDone = false;
    let fitFinalDone = false;

    function tryInitialFit(){
      // If user activated a "special view", do not overwrite it with fitToScreen
      if (specialViewActive) return;

      if (!fitQuickDone && bustoLoaded && tilesLoaded >= 1) {
        fitQuickDone = true;
        viewer.fitToScreen();
      }
      if (!fitFinalDone && bustoLoaded && tilesLoaded >= SASSOCORVARO.tiles) {
        fitFinalDone = true;
        viewer.fitToScreen();
      }
    }

    // =====================
    // DYNAMIC QUALITY WHILE NAVIGATING (DO NOT touch EDL here)
    // =====================
    const QUALITY = {
      moving: { pointBudget: 2_500_000 },
      still:  { pointBudget: 10_000_000 }
    };

    function applyQuality(q){
      viewer.setPointBudget(q.pointBudget);
    }

    if (viewer.controls && typeof viewer.controls.addEventListener === "function") {
      viewer.controls.addEventListener("start", () => applyQuality(QUALITY.moving));
      viewer.controls.addEventListener("end",   () => applyQuality(QUALITY.still));
    }

    // =====================
    // LOAD CLOUDS
    // =====================
    let didInitBustoSlider = false;
    let didInitSassoSlider = false;

    // --- BUSTO (single)
    Potree.loadPointCloud(
      BUSTO.path,
      BUSTO_LABEL,
      e => {
        const pc = e.pointcloud;

        // busto defaults (same as rocca defaults right now, but kept separate)
        const mat = pc.material;
        mat.activeAttributeName = "rgba";
        mat.size = DEFAULTS.busto.size;
        mat.minSize = DEFAULTS.busto.minSize;
        mat.pointSizeType = DEFAULTS.busto.type;

        BUSTO.materials.push(mat);

        pc.visible = BUSTO.visible;
        viewer.scene.addPointCloud(pc);
        BUSTO.pc = pc;

        if (!didInitBustoSlider) {
          didInitBustoSlider = true;
          addPointSizeSliderForGroup({
            id: "ap_pointsize_busto",
            title: "Point size (Busto)",
            materialsRef: BUSTO.materials,
            initialMaterial: mat
          });
        }

        bustoLoaded = true;
        tryInitialFit();
      }
    );

    // --- TILES (batch)
    async function loadSassocorvaroTilesWithLimit(limit = 3){
      let i = 1;

      async function loadOne(idx){
        return new Promise(resolve => {
          const name = `${SASSO_LABEL} – tile ${String(idx).padStart(2, "0")}`;
          const path = `${SASSOCORVARO.base}/tile_${idx}/metadata.json`;

          Potree.loadPointCloud(path, name, e => {
            const pc = e.pointcloud;
            const mat = applyMaterialDefaults(pc, SASSOCORVARO.materials);

            pc.visible = SASSOCORVARO.visible;
            viewer.scene.addPointCloud(pc);
            SASSOCORVARO.pcs.push(pc);

            if (!didInitSassoSlider) {
              didInitSassoSlider = true;
              addPointSizeSliderForGroup({
                id: "ap_pointsize_sassocorvaro",
                title: `Point size (${SASSO_LABEL})`,
                materialsRef: SASSOCORVARO.materials,
                initialMaterial: mat
              });
            }

            tilesLoaded++;
            tryInitialFit();
            resolve();
          });
        });
      }

      const workers = new Array(limit).fill(null).map(async () => {
        while (i <= SASSOCORVARO.tiles){
          const idx = i++;
          await loadOne(idx);
        }
      });

      await Promise.all(workers);
    }

    setTimeout(() => loadSassocorvaroTilesWithLimit(3), 1500);

    // =====================
    // ANNOTATION + VIEW-DEPENDENT SETTINGS
    // =====================

    // Saved camera view (UPDATED with your values)
    const SAVED_POS = new THREE.Vector3(298466.300, 4850599.934, 331.354);
    const SAVED_TGT = new THREE.Vector3(298465.887, 4850599.271, 331.059);

    // Threshold to restore defaults
    const RESTORE_DISTANCE_M = 5.0;

    // Track whether "special view settings" are currently applied
    let specialViewActive = false;

    function setRoccaSpecial(){
      SASSOCORVARO.materials.forEach(m => {
        m.size = 10.0;
        m.minSize = 10.0;
        m.pointSizeType = Potree.PointSizeType.FIXED;
      });

      // sync UI (if present)
      try {
        $("#ap_pointsize_sassocorvaro_slider").slider("value", 10.0);
        $("#ap_pointsize_sassocorvaro_val").text("10.0");
        $("#ap_pointsize_sassocorvaro_type").val("FIXED");
      } catch (_) {}
    }

    function setBustoSpecial(){
      BUSTO.materials.forEach(m => {
        m.size = 0.7;
        m.minSize = 0.7;
        m.pointSizeType = Potree.PointSizeType.ADAPTIVE;
      });

      // sync UI (if present)
      try {
        $("#ap_pointsize_busto_slider").slider("value", 0.7);
        $("#ap_pointsize_busto_val").text("0.7");
        $("#ap_pointsize_busto_type").val("ADAPTIVE");
      } catch (_) {}
    }

    function restoreDefaults(){
      SASSOCORVARO.materials.forEach(m => {
        m.size = DEFAULTS.rocca.size;
        m.minSize = DEFAULTS.rocca.minSize;
        m.pointSizeType = DEFAULTS.rocca.type;
      });

      BUSTO.materials.forEach(m => {
        m.size = DEFAULTS.busto.size;
        m.minSize = DEFAULTS.busto.minSize;
        m.pointSizeType = DEFAULTS.busto.type;
      });

      // sync UI (if present)
      try {
        $("#ap_pointsize_sassocorvaro_slider").slider("value", DEFAULTS.rocca.size);
        $("#ap_pointsize_sassocorvaro_val").text(DEFAULTS.rocca.size.toFixed(1));
        $("#ap_pointsize_sassocorvaro_type").val("FIXED");

        $("#ap_pointsize_busto_slider").slider("value", DEFAULTS.busto.size);
        $("#ap_pointsize_busto_val").text(DEFAULTS.busto.size.toFixed(1));
        $("#ap_pointsize_busto_type").val("FIXED");
      } catch (_) {}
    }

    function goToSavedView(){
      // IMPORTANT: prevent late fitToScreen() calls from overwriting the user-selected view
      fitQuickDone = true;
      fitFinalDone = true;

      viewer.scene.view.position.copy(SAVED_POS);
      viewer.scene.view.lookAt(SAVED_TGT);

      setRoccaSpecial();
      setBustoSpecial();
      specialViewActive = true;

      viewer.render();
    }

    // Clickable annotation
    const ann = new Potree.Annotation({
      title: BUSTO_LABEL,
      position: SAVED_TGT.clone(),
      description: `
        <div style="line-height:1.35">
          <b>${BUSTO_LABEL}</b><br/>
          Clicca per andare al punto di vista.
        </div>
      `
    });

    viewer.scene.annotations.add(ann);

    // Robust handlers across Potree builds
    ann.addEventListener("select", () => goToSavedView());
    ann.addEventListener("click",  () => goToSavedView());
    ann.onClick = () => goToSavedView();

    // Monitor distance from saved target; if user moves away > 5m, restore defaults
    // (lightweight polling, no impact on rendering)
    setInterval(() => {
      if (!specialViewActive) return;

      const camPos = viewer.scene.view.position;
      const d = camPos.distanceTo(SAVED_TGT);

      if (d > RESTORE_DISTANCE_M) {
        restoreDefaults();
        specialViewActive = false;
      }
    }, 500);

    // =====================
    // Optional helpers
    // =====================
    window.showBoth = () => {
      SASSOCORVARO.pcs.forEach(pc => pc.visible = true);
      if (BUSTO.pc) BUSTO.pc.visible = true;
    };
    window.showOnlyBusto = () => {
      SASSOCORVARO.pcs.forEach(pc => pc.visible = false);
      if (BUSTO.pc) BUSTO.pc.visible = true;
    };
    window.showOnlySassocorvaro = () => {
      SASSOCORVARO.pcs.forEach(pc => pc.visible = true);
      if (BUSTO.pc) BUSTO.pc.visible = false;
    };
  </script>

</body>
</html>
