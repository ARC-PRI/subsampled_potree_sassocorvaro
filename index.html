<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="description" content="ROCCA UBALDINESCA">
  <meta name="author" content="ARCANGELO PRIORE">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Potree Viewer – ROCCA UBALDINESCA</title>

  <link rel="stylesheet" href="./build/potree/potree.css">
  <link rel="stylesheet" href="./libs/jquery-ui/jquery-ui.min.css">
  <link rel="stylesheet" href="./libs/openlayers3/ol.css">
  <link rel="stylesheet" href="./libs/spectrum/spectrum.css">
  <link rel="stylesheet" href="./libs/jstree/themes/mixed/style.css">
</head>

<body>

  <!-- LIBS -->
  <script src="./libs/jquery/jquery-3.1.1.min.js"></script>
  <script src="./libs/jquery-ui/jquery-ui.min.js"></script>
  <script src="./libs/spectrum/spectrum.js"></script>
  <script src="./libs/other/BinaryHeap.js"></script>
  <script src="./libs/tween/tween.min.js"></script>
  <script src="./libs/d3/d3.js"></script>
  <script src="./libs/proj4/proj4.js"></script>
  <script src="./libs/openlayers3/ol.js"></script>
  <script src="./libs/i18next/i18next.js"></script>
  <script src="./libs/jstree/jstree.js"></script>
  <script src="./build/potree/potree.js"></script>
  <script src="./libs/plasio/js/laslaz.js"></script>

  <!-- CONTAINER -->
  <div class="potree_container" style="position:absolute; width:100%; height:100%; left:0; top:0;">
    <div id="potree_render_area" style="background-image:url('');"></div>
    <div id="potree_sidebar_container"></div>
  </div>

  <!-- SCRIPT -->
  <script type="module">
    import * as THREE from "./libs/three.js/build/three.module.js";

    // =====================
    // LABELS (single source of truth)
    // =====================
    const SASSO_FOLDER_LABEL = "Rocca Ubaldinesca";
    const BUSTO_LABEL = "Busto di Francesco di Giorgio Martini";
    const BUSTO_FOLDER_LABEL = BUSTO_LABEL;

    // =====================
    // VIEWER
    // =====================
    window.viewer = new Potree.Viewer(document.getElementById("potree_render_area"));

    // EDL: OFF during initial load; will be enabled only when ALL clouds are loaded
    viewer.setEDLEnabled(false);

    viewer.setFOV(60);
    viewer.setPointBudget(10_000_000);
    viewer.loadSettingsFromURL();
    viewer.setDescription("ROCCA UBALDINESCA");

    // Throttle streaming during navigation (if supported by this Potree build)
    if (typeof viewer.setMaxNodesLoading === "function") {
      viewer.setMaxNodesLoading(2);
    } else if (viewer.maxNodesLoading !== undefined) {
      viewer.maxNodesLoading = 2;
    } else if (Potree.maxNodesLoading !== undefined) {
      Potree.maxNodesLoading = 2;
    }

    // Min node size: set to 0 as requested
    if (typeof viewer.setMinNodeSize === "function") {
      viewer.setMinNodeSize(0);
    }

    let guiLoaded = false;

    viewer.loadGUI(() => {
      guiLoaded = true;
      viewer.setLanguage("en");
      $("#menu_appearance").next().show();

      // If clouds are already loaded by the time GUI is ready, group immediately.
      tryGroupPointCloudsTreeAfterLoad();
    });

    // =====================
    // CONFIG DATASETS
    // =====================
    const SASSOCORVARO = {
      base: "./pointclouds/sassocorvaro",
      tiles: 20,
      pcs: [],
      materials: [],
      visible: true
    };

    const BUSTO = {
      path: "./pointclouds/busto/metadata.json",
      pc: null,
      materials: [],
      visible: true
    };

    // =====================
    // MATERIAL DEFAULTS (keeps native Potree UI options)
    // =====================
    function applyMaterialDefaults(pc, materialsArr){
      const mat = pc.material;

      mat.activeAttributeName = "rgba";
      mat.size = 2.0;
      mat.minSize = 2;
      mat.pointSizeType = Potree.PointSizeType.FIXED;

      materialsArr.push(mat);
      return mat;
    }

    // =====================
    // TWO SEPARATE POINT-SIZE SLIDERS (one per cloud)
    // =====================
    function addPointSizeSliderForGroup(opts){
      const { id, title, materialsRef, initialMaterial } = opts;

      const $appearancePanel = $("#menu_appearance").next();
      if ($appearancePanel.length === 0) {
        setTimeout(() => addPointSizeSliderForGroup(opts), 200);
        return;
      }

      // remove only our custom block (do NOT touch native Potree controls)
      $(`#${id}`).remove();

      const typeToValue = t =>
        t === Potree.PointSizeType.ATTENUATED ? "ATTENUATED" :
        t === Potree.PointSizeType.ADAPTIVE   ? "ADAPTIVE"   : "FIXED";

      const valueToType = v =>
        v === "ATTENUATED" ? Potree.PointSizeType.ATTENUATED :
        v === "ADAPTIVE"   ? Potree.PointSizeType.ADAPTIVE   :
                             Potree.PointSizeType.FIXED;

      const block = $(`
        <div class="pv-menu-list" id="${id}">
          <div class="pv-menu-entry">

            <div style="font-weight:600; margin-bottom:8px;">${title}</div>

            <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
              <span>Point size</span>
              <span id="${id}_val">${initialMaterial.size.toFixed(1)}</span>
            </div>

            <div id="${id}_slider" style="margin:0 4px;"></div>

            <div id="${id}_note"
                 style="margin-top:6px; font-size:11px; color:#999; display:none;">
              controlled by distance
            </div>

            <div style="display:flex; justify-content:space-between; margin-top:8px;">
              <span>Size mode</span>
              <select id="${id}_type" style="width:140px;">
                <option value="FIXED">Fixed</option>
                <option value="ATTENUATED">Attenuated</option>
                <option value="ADAPTIVE">Adaptive</option>
              </select>
            </div>

          </div>
        </div>
      `);

      // put blocks near top of Appearance without removing anything else
      const $firstBlock = $appearancePanel.find(".pv-menu-list").first();
      $firstBlock.after(block);

      $(`#${id}_type`).val(typeToValue(initialMaterial.pointSizeType));

      $(`#${id}_slider`).slider({
        min: 0.5,
        max: 10,
        step: 0.1,
        value: initialMaterial.size,
        slide: (e, ui) => {
          materialsRef.forEach(m => { m.size = ui.value; });
          $(`#${id}_val`).text(ui.value.toFixed(1));
        }
      });

      function applyMode(mode){
        const $slider = $(`#${id}_slider`);
        const $note = $(`#${id}_note`);

        const t = valueToType(mode);
        materialsRef.forEach(m => { m.pointSizeType = t; });

        if (mode === "ATTENUATED") {
          $slider.slider("disable");
          $note.show();
          return;
        }

        $slider.slider("enable");
        $note.hide();

        if (mode === "ADAPTIVE") {
          $slider.slider("option", "max", 3);
          if ($slider.slider("value") > 3) {
            $slider.slider("value", 3);
            materialsRef.forEach(m => { m.size = 3; });
            $(`#${id}_val`).text("3.0");
          }
        } else {
          $slider.slider("option", "max", 10);
        }
      }

      applyMode(typeToValue(initialMaterial.pointSizeType));

      $(`#${id}_type`).on("change", function(){
        applyMode($(this).val());
      });
    }

    // =====================
    // GROUP POINT CLOUDS IN TREE (ONLY AFTER ALL CLOUDS ARE LOADED)
    // =====================
    let didGroupTree = false;

    function groupPointCloudsInTreeAfterLoad(){
      if (didGroupTree) return;

      const $treeEl = $("#jstree_scene");
      if ($treeEl.length === 0) return;

      const tree = $treeEl.jstree(true);
      if (!tree) return;

      // find "Point Clouds"
      const flatAll = tree.get_json("#", { flat: true }) || [];
      const pcRootId = flatAll.find(n => n && n.text === "Point Clouds")?.id;
      if (!pcRootId) return;

      // ensure folders exist under "Point Clouds"
      const children = tree.get_children_dom(pcRootId).toArray().map(el => tree.get_node(el));
      let sFolderId = children.find(n => n.text === SASSO_FOLDER_LABEL)?.id;
      let bFolderId = children.find(n => n.text === BUSTO_FOLDER_LABEL)?.id;

      if (!sFolderId) {
        sFolderId = tree.create_node(pcRootId, { text: SASSO_FOLDER_LABEL, icon: "jstree-folder" }, "last");
      }
      if (!bFolderId) {
        bFolderId = tree.create_node(pcRootId, { text: BUSTO_FOLDER_LABEL, icon: "jstree-folder" }, "last");
      }
      if (!sFolderId || !bFolderId) return;

      // move nodes into folders
      const flat = tree.get_json("#", { flat: true }) || [];
      for (const n of flat){
        if (!n || !n.text) continue;

        // all tiles have label: "Rocca Ubaldinesca – tile XX"
        if (n.text.startsWith(SASSO_FOLDER_LABEL + " – tile")) {
          if (n.parent !== sFolderId) tree.move_node(n.id, sFolderId, "last");
        }

        // busto label
        if (n.text === BUSTO_LABEL) {
          if (n.parent !== bFolderId) tree.move_node(n.id, bFolderId, "last");
        }
      }

      tree.open_node(pcRootId);
      tree.open_node(sFolderId);
      tree.open_node(bFolderId);

      didGroupTree = true;
    }

    function tryGroupPointCloudsTreeAfterLoad(){
      // group only if GUI + all point clouds loaded
      if (!guiLoaded) return;
      if (!allCloudsLoaded()) return;
      groupPointCloudsInTreeAfterLoad();
    }

    // =====================
    // INITIAL FIT (fast + final) + "ALL LOADED" hook for EDL enable
    // =====================
    let bustoLoaded = false;
    let tilesLoaded = 0;

    let fitQuickDone = false;
    let fitFinalDone = false;
    let edlEnabledAfterLoad = false;

    function allCloudsLoaded(){
      return bustoLoaded && tilesLoaded >= SASSOCORVARO.tiles;
    }

    function tryEnableEDLAfterLoad(){
      if (edlEnabledAfterLoad) return;
      if (!allCloudsLoaded()) return;

      edlEnabledAfterLoad = true;
      viewer.setEDLEnabled(true);
    }

    function tryInitialFit(){
      // quick fit when busto + at least one tile are present
      if (!fitQuickDone && bustoLoaded && tilesLoaded >= 1) {
        fitQuickDone = true;
        viewer.fitToScreen();
      }

      // final fit when everything is loaded
      if (!fitFinalDone && allCloudsLoaded()) {
        fitFinalDone = true;
        viewer.fitToScreen();
      }

      // enable EDL only after all clouds are loaded
      tryEnableEDLAfterLoad();

      // group tree only after all clouds are loaded (and GUI is ready)
      tryGroupPointCloudsTreeAfterLoad();
    }

    // =====================
    // DYNAMIC QUALITY WHILE NAVIGATING (keeps EDL off while moving even after load)
    // =====================
    const QUALITY = {
      moving: { pointBudget: 2_500_000, edl: false },
      still:  { pointBudget: 10_000_000, edl: true  }
    };

    function applyQuality(q){
      viewer.setPointBudget(q.pointBudget);

      // Only allow EDL=true after initial load is complete
      if (q.edl) {
        if (allCloudsLoaded()) viewer.setEDLEnabled(true);
      } else {
        viewer.setEDLEnabled(false);
      }
    }

    if (viewer.controls && typeof viewer.controls.addEventListener === "function") {
      viewer.controls.addEventListener("start", () => applyQuality(QUALITY.moving));
      viewer.controls.addEventListener("end",   () => applyQuality(QUALITY.still));
    }

    // =====================
    // LOAD CLOUDS
    // =====================
    let didInitBustoSlider = false;
    let didInitSassoSlider = false;

    // --- BUSTO (single)
    Potree.loadPointCloud(
      BUSTO.path,
      BUSTO_LABEL,
      e => {
        const pc = e.pointcloud;
        const mat = applyMaterialDefaults(pc, BUSTO.materials);

        pc.visible = BUSTO.visible;
        viewer.scene.addPointCloud(pc);
        BUSTO.pc = pc;

        if (!didInitBustoSlider) {
          didInitBustoSlider = true;
          addPointSizeSliderForGroup({
            id: "ap_pointsize_busto",
            title: "Point size (Busto)",
            materialsRef: BUSTO.materials,
            initialMaterial: mat
          });
        }

        bustoLoaded = true;
        tryInitialFit();
      }
    );

    // =====================
    // TILE BATCH LOADER (3 at a time)
    // =====================
    async function loadSassocorvaroTilesWithLimit(limit = 3){
      let i = 1;

      async function loadOne(idx){
        return new Promise(resolve => {
          const name = `${SASSO_FOLDER_LABEL} – tile ${String(idx).padStart(2, "0")}`;
          const path = `${SASSOCORVARO.base}/tile_${idx}/metadata.json`;

          Potree.loadPointCloud(path, name, e => {
            const pc = e.pointcloud;
            const mat = applyMaterialDefaults(pc, SASSOCORVARO.materials);

            pc.visible = SASSOCORVARO.visible;
            viewer.scene.addPointCloud(pc);
            SASSOCORVARO.pcs.push(pc);

            if (!didInitSassoSlider) {
              didInitSassoSlider = true;
              addPointSizeSliderForGroup({
                id: "ap_pointsize_sassocorvaro",
                title: "Point size (Rocca Ubaldinesca)",
                materialsRef: SASSOCORVARO.materials,
                initialMaterial: mat
              });
            }

            tilesLoaded++;
            tryInitialFit();

            resolve();
          });
        });
      }

      const workers = new Array(limit).fill(null).map(async () => {
        while (i <= SASSOCORVARO.tiles){
          const idx = i++;
          await loadOne(idx);
        }
      });

      await Promise.all(workers);
    }

    // delay tiles a bit to get the page responsive faster
    setTimeout(() => loadSassocorvaroTilesWithLimit(3), 1500);

    // =====================
    // Optional helpers
    // =====================
    window.showBoth = () => {
      SASSOCORVARO.pcs.forEach(pc => pc.visible = true);
      if (BUSTO.pc) BUSTO.pc.visible = true;
    };
    window.showOnlyBusto = () => {
      SASSOCORVARO.pcs.forEach(pc => pc.visible = false);
      if (BUSTO.pc) BUSTO.pc.visible = true;
    };
    window.showOnlySassocorvaro = () => {
      SASSOCORVARO.pcs.forEach(pc => pc.visible = true);
      if (BUSTO.pc) BUSTO.pc.visible = false;
    };
  </script>

</body>
</html>
